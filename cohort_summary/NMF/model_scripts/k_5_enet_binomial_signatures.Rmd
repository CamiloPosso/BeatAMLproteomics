---
title: "Cluster 5 binomial signatures"
author: "Camilo Posso"
date: "04/04/2022"
output: 
  html_document:
    code_folding: hide
    toc: true
editor_options: 
  chunk_output_type: inline
---

## Goal




```{r include=FALSE}
library(dplyr)
library(ggplot2)
library(glmnet)
library(clusterProfiler)
library(msigdbr)
library(RColorBrewer)

source("../../../util/synapseUtil.R")
source("../../../util/loading_data.R")
source("../../../util/mutational_analysis_helper.R")
source("../../../util/make_plots_util.R")


load("../../../Misc/load.combined.data 3-09-2022.RData")
# load.combined.data()
global_data <- global.data
RNA_data <- RNA.data %>%
  dplyr::rename(LogRatio = `RNA counts`)

```



```{r}
cluster_assignments <- read.table("../Data/sample_to_cluster_assignments.txt", sep = "\t")

diff_markers_k5 <- read.table("../../../Misc/Extra NMF/whoknows/differential_markers_k5.txt", sep = "\t")

summary.syn <- "syn26642974"
summary.table <- read.table("../Data/PNNL_clinical_summary_12_08_2021_updated_OS_4patients_02_28_2022.txt") %>%
  as.data.frame()

rownames(summary.table) <- summary.table$labId
summary.table <- summary.table[rownames(meta), ]
meta$vitalStatus <- summary.table$vitalStatus
meta <- meta %>%
  dplyr::mutate(vitalStatus = case_when(vitalStatus == "Dead" ~ 2,
                                 TRUE ~ 1))

cluster_samples <- cluster_assignments$Barcode.ID

global_data <- global.data %>%
  dplyr::filter(Barcode.ID %in% cluster_samples)

global_data_test <- global.data %>%
  dplyr::filter(!(Barcode.ID %in% cluster_samples))


mat_df <- pivot_wider(global_data, names_from = Barcode.ID, 
                   values_from = LogRatio) %>%
  as.data.frame() 
rownames(mat_df) <- mat_df$Gene

data_mat_train_all <- mat_df[, -1] %>% as.matrix()


mat_test_df <- pivot_wider(global_data_test, names_from = Barcode.ID, 
                           values_from = LogRatio) %>%
  as.data.frame() 
rownames(mat_test_df) <- mat_df$Gene
data_mat_test_all <- mat_test_df[, -1] %>% as.matrix()

complete_cases <- complete.cases(data_mat_train_all) & complete.cases(data_mat_test_all)
data_mat_train_all <- data_mat_train_all[complete_cases, ]
data_mat_test_all <- data_mat_test_all[complete_cases, ]

```


Loading model results.


```{r}
all_results <- readRDS("elastic_net_binomial_models/elastic_net_results_k_5.RDS")
bounds <- readRDS("elastic_net_binomial_models/bounds.RDS")
min_bounds_all <- bounds$min_bounds_all
max_bounds_all <- bounds$max_bounds_all
min_bounds_mark <- bounds$min_bounds_mark
max_bounds_mark <- bounds$max_bounds_mark
bound_mult <- bounds$bound_mult

```



Getting cluster signatures.



```{r include=FALSE}
  
signatures <- data.frame(Cluster = c(), Gene = c(), alpha = c(), diff_marker = c())
for (diff_markers in c(TRUE, FALSE)) {
  if (diff_markers){
    min_bounds <- min_bounds_mark
    max_bounds <- max_bounds_mark
  } else {
    min_bounds <- min_bounds_all
    max_bounds <- max_bounds_all
  }
  for (chosen_cluster in c("1", "2", "3", "4", "5")){
    for (chosen_alpha in c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0)) {
      if (diff_markers){
        results_name <- paste0("Cluster ", chosen_cluster, " diff markers")
        data_mat <- data_mat_train_all
        cluster_markers <- diff_markers_k5 %>% 
          dplyr::filter(Cluster == chosen_cluster) %>%
          dplyr::filter(data_type == "Global") %>%
          dplyr::filter(significance < 0.05) %>%
          dplyr::filter(feature %in% rownames(data_mat_train_all)) %>%
          pull(feature)
        
        data_mat <- data_mat[cluster_markers, ]
      } else {
        results_name <- paste0("Cluster ", chosen_cluster, " all data")
        data_mat <- data_mat_train_all
      }
      
      cluster_lab <- paste("Cluster", chosen_cluster)
      xx <- all_results[[results_name]]
      
      min_lambda <- min_bounds[[as.character(chosen_alpha), chosen_cluster]]
      max_lambda <- max_bounds[[as.character(chosen_alpha), chosen_cluster]]
      allowed_lambda <- (as.numeric(rownames(xx)) < max_lambda) & 
                        (as.numeric(rownames(xx)) > min_lambda)
      xx <- xx[allowed_lambda, ]
      col_name <- paste("alpha =", chosen_alpha)
      chosen_lambda <- rownames(xx)[[which.min(xx[[col_name]])]] %>%
        as.numeric()
      
      cluster_bool <- cluster_assignments %>%
        dplyr::mutate(cluster_bool = case_when(k.5 == chosen_cluster ~ cluster_lab,
                                          TRUE ~ paste("Not", cluster_lab))) %>%
        pull(cluster_bool) %>%
        as.factor()
      
      names(cluster_bool) <- cluster_assignments$Barcode.ID
      cluster_bool <- cluster_bool[colnames(data_mat)]
      model <- glmnet(x = t(data_mat),
                      y = cluster_bool,
                      family = 'binomial',
                      alpha = chosen_alpha,
                      lambda = chosen_lambda)
      
      coefs <- coef(model, s = model$lambda) %>% as.matrix()
      sigs <- rownames(coefs)[coefs != 0]
      signatures <- rbind(signatures, data.frame(Cluster = chosen_cluster, Gene = sigs, 
                                                 alpha = chosen_alpha, diff_marker = diff_markers))
    }
  }
}

signatures <- signatures %>%
  filter(Gene != "(Intercept)")

write.table(signatures, "elastic_net_binomial_models/enet_binomial_all_signatures.txt", sep = "\t", quote = F)

```


```{r eval=FALSE, include=FALSE}
# signatures <- read.table("elastic_net_binomial_models/enet_binomial_all_signatures.txt", sep = "\t")

```

Signature heatmap


```{r}
chosen.colors <- subtype_colors[1:5]

chosen_alpha <- 0.1
signatures <- signatures %>%
  group_by(diff_marker, alpha, Gene) %>%
  dplyr::mutate(total = n()) %>%
  ungroup()

row_df <- signatures %>%
  dplyr::filter(alpha == chosen_alpha) %>%
  dplyr::filter(diff_marker == FALSE) %>%
  dplyr::select(Gene, Cluster) %>%
  group_by(Gene) %>%
  dplyr::mutate(total = n()) %>%
  dplyr::mutate(Cluster = case_when(total == 1 ~ as.character(Cluster),
                                    TRUE ~ "Mixed"),
                Cluster = factor(Cluster, levels = c("1", "2", "3", "4", "5", "Mixed"))) %>%
  unique() %>%
  as.data.frame()
rownames(row_df) <- row_df$Gene

col_df <- meta %>%
  dplyr::select(Barcode.ID) %>%
  merge(cluster_assignments, by = "Barcode.ID") %>%
  dplyr::select(k.5, Barcode.ID) %>%
  dplyr::rename(Cluster = k.5) %>%
  dplyr::mutate(Cluster = as.factor(Cluster)) 
rownames(col_df) <- col_df$Barcode.ID
col_df <- col_df %>%
  select(Cluster)

ann_colors <- list("Cluster" = c("1" = chosen.colors[[1]], 
                                 "2" = chosen.colors[[2]],
                                 "3" = chosen.colors[[3]],
                                 "4" = chosen.colors[[4]],
                                 "5" = chosen.colors[[5]],
                                 "Mixed" = "grey"))

heatmap_breaks <- seq(-3, 3, by = 0.2)
heatmap_colors <- colorRampPalette(rev(brewer.pal(n = 10, name = "RdYlBu")))(length(heatmap_breaks))
cluster_row = pheatmap:::cluster_mat(data_mat_train_all[rownames(row_df), ], distance = "euclidean", 
                                     method = "ward.D")
row_df <- row_df[cluster_row$order, ] %>%
  mutate(order = 1:n()) %>%
  arrange(Cluster) %>%
  select(Cluster)
sigs <- rownames(row_df)
file_path <- paste0("./elastic_net_binomial_models/enet_binomial_signature_heatmap_mult_", bound_mult)

make.pheatmap(data_mat_train_all[sigs, ], filename = file_path, format = "pdf",
              scale = "row", cluster_rows = FALSE, clustering_method = "ward.D", 
              annotation_col = col_df, annotation_row = row_df, annotation_colors = ann_colors,
              breaks = heatmap_breaks, color = heatmap_colors, show_rownames = F, show_colnames = F,
              main = paste0(length(sigs), " total features, alpha = ", chosen_alpha), height = 7, width = 7)

```




