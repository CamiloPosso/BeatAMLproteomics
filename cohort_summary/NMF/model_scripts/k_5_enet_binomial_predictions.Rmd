---
title: "Cluster 5 binomial predictions"
author: "Camilo Posso"
date: "04/01/2022"
output: 
  html_document:
    code_folding: hide
    toc: true
editor_options: 
  chunk_output_type: inline
---

## Goal




```{r include=FALSE}
library(dplyr)
library(ggplot2)
library(kableExtra)
library(glmnet)
library(survminer)
library(survival)
library(groupdata2)


source("../../../util/synapseUtil.R")
source("../../../util/loading_data.R")
source("../../../util/mutational_analysis_helper.R")
source("../../../util/make_plots_util.R")
source("../NMF_helper.R")


load("../../../Misc/load.combined.data 3-09-2022.RData")
# load.combined.data()
global_data <- global.data
RNA_data <- RNA.data %>%
  dplyr::rename(LogRatio = `RNA counts`)

```



```{r}

cluster_assignments <- read.table("../Data/sample_to_cluster_assignments.txt", sep = "\t")
diff_markers_k5 <- read.table("../../../Misc/Extra NMF/whoknows/differential_markers_k5.txt", sep = "\t")

summary.syn <- "syn26642974"
summary.table <- read.table("../Data/PNNL_clinical_summary_12_08_2021_updated_OS_4patients_02_28_2022.txt") %>%
  as.data.frame()

rownames(summary.table) <- summary.table$labId
summary.table <- summary.table[rownames(meta), ]
meta$vitalStatus <- summary.table$vitalStatus
meta <- meta %>%
  mutate(vitalStatus = case_when(vitalStatus == "Dead" ~ 2,
                                 TRUE ~ 1))

cluster_samples <- cluster_assignments$Barcode.ID
global_data <- global.data %>%
  filter(Barcode.ID %in% cluster_samples)
global_data_test <- global.data %>%
  filter(!(Barcode.ID %in% cluster_samples))


mat_df <- pivot_wider(global_data, names_from = Barcode.ID, 
                   values_from = LogRatio) %>%
  as.data.frame() 
rownames(mat_df) <- mat_df$Gene

data_mat_train_all <- mat_df[, -1] %>% as.matrix()

mat_test_df <- pivot_wider(global_data_test, names_from = Barcode.ID, 
                           values_from = LogRatio) %>%
  as.data.frame() 
rownames(mat_test_df) <- mat_df$Gene
data_mat_test_all <- mat_test_df[, -1] %>% as.matrix()

complete_cases <- complete.cases(data_mat_train_all) & complete.cases(data_mat_test_all)
data_mat_train_all <- data_mat_train_all[complete_cases, ]
data_mat_test_all <- data_mat_test_all[complete_cases, ]

```


```{r}
all_results <- readRDS("elastic_net_binomial_models/elastic_net_results_k_5.RDS")
bounds <- readRDS("elastic_net_binomial_models/bounds.RDS")
min_bounds_all <- bounds$min_bounds_all
max_bounds_all <- bounds$max_bounds_all
min_bounds_mark <- bounds$min_bounds_mark
max_bounds_mark <- bounds$max_bounds_mark
bound_mult <- bounds$bound_mult

```



Here we train a prediction model using the full dataset and the best performing hyperparameters
to extend cluster 5 (good prognosis) to the 51 unclustered samples.


```{r}

make_prediction <- function(chosen_cluster, chosen_alpha, diff_markers){
  col_name <- paste("alpha =", chosen_alpha)
  if (!diff_markers){
    xx <- all_results[[paste("Cluster", chosen_cluster, "all data")]]
  } else {
    xx <- all_results[[paste("Cluster", chosen_cluster, "diff markers")]]
  }
  
  data_mat <- data_mat_train_all
  data_mat_test <- data_mat_test_all
  min_bounds <- min_bounds_all
  max_bounds <- max_bounds_all
  if (diff_markers){
    cluster_markers <- diff_markers_k5 %>% 
      filter(Cluster == chosen_cluster) %>%
      filter(data_type == "Global") %>%
      filter(significance < 0.05) %>%
      filter(feature %in% rownames(data_mat_train_all)) %>%
      pull(feature)
    
    data_mat <- data_mat[cluster_markers, ]
    data_mat_test <- data_mat_test[cluster_markers, ]
    min_bounds <- min_bounds_mark
    max_bounds <- max_bounds_mark
  }
  
  min_lambda <- min_bounds[[as.character(chosen_alpha), chosen_cluster]]
  max_lambda <- max_bounds[[as.character(chosen_alpha), chosen_cluster]]
  allowed_lambda <- (as.numeric(rownames(xx)) < max_lambda) & 
                    (as.numeric(rownames(xx)) > min_lambda)
  xx <- xx[allowed_lambda, ]
  col_name <- paste("alpha =", chosen_alpha)
  chosen_lambda <- rownames(xx)[[which.min(xx[[col_name]])]] %>%
    as.numeric()

  print(chosen_lambda)
  
  data_mat <- sweep(data_mat, 1, apply(data_mat, 1, mean), FUN = '-')
  data_mat <- sweep(data_mat, 1, apply(data_mat, 1, sd), FUN = '/')
  
  data_mat_test <- sweep(data_mat_test, 1, apply(data_mat_test, 1, mean), FUN = '-')
  data_mat_test <- sweep(data_mat_test, 1, apply(data_mat_test, 1, sd), FUN = '/')
  
  cluster_lab <- paste("Cluster", chosen_cluster)
  
  cluster_bool <- cluster_assignments %>%
    mutate(cluster_bool = case_when(k.5 == chosen_cluster ~ cluster_lab,
                                      TRUE ~ paste("Not", cluster_lab))) %>%
    pull(cluster_bool) %>%
    as.factor()
  
  names(cluster_bool) <- cluster_assignments$Barcode.ID
  cluster_bool <- cluster_bool[colnames(data_mat)]

  model <- glmnet(x = t(data_mat),
                  y = cluster_bool,
                  family = 'binomial',
                  alpha = chosen_alpha,
                  lambda = chosen_lambda)
  
  cluster_predictions <- predict(model, s = chosen_lambda, newx = t(data_mat_test), type = "class")
  cluster_probs <- predict(model, s = chosen_lambda, newx = t(data_mat_test), type = "response")
  
  out <- data.frame(Barcode.ID = colnames(data_mat_test))  
  out[[cluster_lab]] <- cluster_predictions %>% as.character()
  out[[paste(cluster_lab, "probs")]] <- cluster_probs %>% as.numeric()
  return(out)
}


make_prediction_plot <- function(chosen_cluster, chosen_alpha, diff_markers){
  
  predictions <- make_prediction(chosen_cluster, chosen_alpha, diff_markers)
  meta_c <- left_join(meta, cluster_assignments, by = "Barcode.ID") %>%
    mutate(overallSurvival = as.numeric(overallSurvival),
           k.5 = as.character(k.5))
  rownames(meta_c) <- meta_c$Barcode.ID
 
  plot_df <- meta_c %>%
    filter(is.na(k.5)) %>%
    merge(predictions, by = "Barcode.ID") 
  plot_df[["Cluster"]] <- plot_df[[paste("Cluster", chosen_cluster)]]
  
  chosen.colors <- c("#F8766D", "#CD9600", "#7CAE00", "#00BE67", 
                     "#00BFC4", "#00A9FF", "#C77CFF", "#FF61CC")
  plot_title <- paste("51 non clustered samples, chosen alpha", chosen_alpha)
  
  sfit <- survfit(Surv(overallSurvival, vitalStatus) ~ Cluster, data = plot_df)
  ggsurvplot(sfit, palette = chosen.colors[1:2], pval = TRUE, data = plot_df) + 
    ggtitle(plot_title)
  
  plot_path <- paste0("elastic_net_binomial_models/51_samples_cluster_", chosen_cluster, "_alpha_", 
                      chosen_alpha, "_best_lambda_diff_", diff_markers, ".pdf")
  ggsave(plot_path)
}

```



Predicting on the 51 unclustered samples.



```{r}
meta_c <- left_join(meta, cluster_assignments, by = "Barcode.ID") %>%
  mutate(overallSurvival = as.numeric(overallSurvival),
         k.5 = as.character(k.5))
rownames(meta_c) <- meta_c$Barcode.ID

meta_c_new <- meta_c %>%
    filter(is.na(k.5))

meta_c_train <- meta_c %>%
  filter(!is.na(k.5))


cluster_5 <- make_prediction("5", 0.1, FALSE)
cluster_4 <- make_prediction("4", 0.1, FALSE)
cluster_3 <- make_prediction("3", 0.1, FALSE)
cluster_2 <- make_prediction("2", 0.1, FALSE)
cluster_1 <- make_prediction("1", 0.1, FALSE)

chosen.colors <- subtype_colors

all <- cbind(cluster_1, cluster_2, cluster_3, cluster_4, cluster_5)
probs <- all[,c(3,6,9,12,15)]
probs$assgn <- apply(probs[, 1:5], 1, which.min)
probs$min <- apply(probs, 1, min)
probs$Barcode.ID <- all$Barcode.ID

meta_c_new <- left_join(meta_c_new, probs, by = "Barcode.ID") %>%
  mutate(conf = case_when(min > 0.7 ~ "Low confidence",
                          TRUE ~ "OK"))

meta_c_plot <- meta_c_new %>%
  filter(conf == "OK")

sfit <- survfit(Surv(overallSurvival, vitalStatus) ~ assgn, data = meta_c_plot)
ggsurvplot(sfit, palette = chosen.colors[1:5], data = meta_c_plot) + ggtitle("Unclustered samples, conf > 30% (37/51 samples)")
ggsave("elastic_net_binomial_models/survival_predicted_clusters_enet_binomial.pdf", width = 7, height = 7)

sfit <- survfit(Surv(overallSurvival, vitalStatus) ~ k.5, data = meta_c_train)
ggsurvplot(sfit, palette = chosen.colors[1:5], data = meta_c_train) + ggtitle("159 Clustered samples")
ggsave("elastic_net_binomial_models/survival_clustered_samples.pdf", width = 7, height = 7)

```


Mutation status 


```{r}
all_mutation_data <- load_mutational_sample_data()
mutation_data <- all_mutation_data %>%
  mutate(value = TRUE) %>%
  pivot_wider(names_from = Gene, values_from = value, values_fn = any)
mutation_data <- mutation_data[, c("Barcode.ID", "NPM1", "NPM1_clinical")]

meta_c_new <- meta_c_new %>%
  left_join(mutation_data, by = "Barcode.ID") %>%
  mutate(`Cluster 3` = case_when(assgn == "3" ~ "Cluster 3",
                                        TRUE ~ "Not Cluster 3")) %>%
  mutate(FLT3 = case_when(FLT3.ITD == "TRUE" ~ TRUE,
                          TRUE ~ FALSE),
         NPM1 = case_when(!is.na(NPM1) ~ NPM1,
                          TRUE ~ FALSE),
         NPM1_clinical = case_when(!is.na(NPM1_clinical) ~ NPM1_clinical,
                                   TRUE ~ FALSE))

meta_c_train <- meta_c %>%
  filter(!is.na(k.5)) %>%
  left_join(mutation_data, by = "Barcode.ID") %>%
  mutate(`Cluster 3` = case_when(k.5 == "3" ~ "Cluster 3",
                                 TRUE ~ "Not Cluster 3")) %>%
  mutate(FLT3 = case_when(FLT3.ITD == "TRUE" ~ TRUE,
                          TRUE ~ FALSE),
         NPM1 = case_when(!is.na(NPM1) ~ NPM1,
                          TRUE ~ FALSE),
         NPM1_clinical = case_when(!is.na(NPM1_clinical) ~ NPM1_clinical,
                                   TRUE ~ FALSE))

```



Get enrichment of NPM1, FLT3 within predicted cluster.



```{r}
sample_categories_new <- meta_c_new %>%
  filter(conf == "OK") %>%
  select(Barcode.ID, FLT3, NPM1, NPM1_clinical)

assignments_new <- meta_c_new %>%
  filter(conf == "OK") %>%
  select(Barcode.ID, assgn) %>%
  dplyr::rename(Cluster = assgn)

sample_categories_train <- meta_c_train %>%
  select(Barcode.ID, FLT3, NPM1, NPM1_clinical)

assignments_train <- meta_c_train %>%
  select(Barcode.ID, k.5) %>%
  dplyr::rename(Cluster = k.5)


get_enrichment <- function(sample_categories, assignments, log.scale = FALSE) {
  k = length(unique(assignments$Cluster))
  
  sample_categories <- sample_categories %>%
    filter(rownames(.) %in% rownames(assignments)) %>%
    left_join(assignments, by = "Barcode.ID") %>%
    column_to_rownames("Barcode.ID") %>% 
    as.data.frame()
  
  categories <- sample_categories %>%
    select(-Cluster) %>%
    colnames()
  
  out <- lapply(categories, function(category){
    
    p.values <- sapply(1:k, function(i){
      cluster.df <- sample_categories %>%
        mutate(Cluster = case_when(Cluster == i ~ TRUE,
                                   TRUE ~ FALSE)) %>%
        mutate(Cluster = as.factor(Cluster))
      dat <- table(cluster.df[[category]], cluster.df$Cluster)
      fisher.test(dat, workspace = 2e8, alternative = "greater")$p.value
    })
    
    if (log.scale) {
      p.values <- -log10(p.values)
    } else {
      p.values <- p.values
    }
    
  }) %>% do.call(cbind, .) %>% as.data.frame()
  
  colnames(out) <- paste0("Enrichment in ", categories)
  out <- out %>%
    mutate(Cluster = 1:k) %>%
    select(Cluster, everything())
}

mutation_enrichment_new <- get_enrichment(sample_categories_new, assignments_new)
mutation_enrichment_train <- get_enrichment(sample_categories_train, assignments_train)

```





Summary of cluster 3 mutations.





```{r}
meta_new_show <- meta_c_new %>%
  filter(conf == "OK") %>%
  dplyr::select(Barcode.ID, `Cluster 3`, FLT3, NPM1, NPM1_clinical) %>%
  dplyr::group_by(`Cluster 3`) %>%
  dplyr::mutate(`Fraction FLT3.ITD Cluster` = sum(FLT3)/n(),
                `Fraction NPM1 Cluster` = sum(NPM1)/n(),
                `Fraction NPM1_clinical Cluster` = sum(NPM1_clinical)/n()) %>%
  ungroup(`Cluster 3`) %>%
  dplyr::mutate(`Fraction FLT3.ITD Background` = sum(FLT3)/n(),
                `Fraction NPM1 Background` = sum(NPM1)/n(),
                `Fraction NPM1_clinical Background` = sum(NPM1_clinical)/n()) %>%
  arrange(`Cluster 3`)

meta_train_show <- meta_c_train %>%
  dplyr::select(Barcode.ID, `Cluster 3`, FLT3, NPM1, NPM1_clinical) %>%
  dplyr::group_by(`Cluster 3`) %>%
  dplyr::mutate(`Fraction FLT3.ITD Cluster` = sum(FLT3)/n(),
                `Fraction NPM1 Cluster` = sum(NPM1)/n(),
                `Fraction NPM1_clinical Cluster` = sum(NPM1_clinical)/n()) %>%
  ungroup(`Cluster 3`) %>%
  dplyr::mutate(`Fraction FLT3.ITD Background` = sum(FLT3)/n(),
                `Fraction NPM1 Background` = sum(NPM1)/n(),
                `Fraction NPM1_clinical Background` = sum(NPM1_clinical)/n()) %>%
  arrange(`Cluster 3`)


show_df1 <- meta_new_show %>%
  filter(`Cluster 3` == "Cluster 3") %>%
  select(matches("Fraction")) %>%
  unique() %>%
  mutate(Group = c("Predicted"))

show_df2 <- meta_train_show %>%
  filter(`Cluster 3` == "Cluster 3") %>%
  select(matches("Fraction")) %>%
  unique() %>%
  mutate(Group = c("Train"))

show_df <- rbind(show_df1, show_df2) %>%
  pivot_longer(-Group, names_to = "Fraction") %>%
  mutate(mutation = sub("Fraction (.*) .*$", "\\1", Fraction),
         Setting = sub("Fraction .* (.*)$", "\\1", Fraction)) 

mut_enrichment <- mutation_enrichment_train[3, 2:4] %>% unlist() %>% unname() %>% signif(3)
plot_df_train <- show_df %>%
  filter(Group == "Train")
plot_df_train$mutation <- paste(plot_df_train$mutation, mut_enrichment)

mut_enrichment <- mutation_enrichment_new[3, 2:4] %>% unlist() %>% unname() %>% signif(3)
plot_df_new <- show_df %>%
  filter(Group == "Predicted")
plot_df_new$mutation <- paste(plot_df_new$mutation, mut_enrichment)

ggplot(plot_df_new, aes(x = mutation, y = value, group = Setting, fill = Setting)) + 
  geom_bar(stat = 'identity', position = position_dodge()) +
  scale_fill_manual(values = c("Cluster" = "#16182A", "Cluster" = "grey")) +
  ylab("Fraction") + ggtitle("Unclustered samples, cluster 3")
ggsave("elastic_net_binomial_models/mutation_enrichment_predicted_cluster_3.pdf", height = 7, width = 7)

ggplot(plot_df_train, aes(x = mutation, y = value, group = Setting, fill = Setting)) + 
  geom_bar(stat = 'identity', position = position_dodge()) +
  scale_fill_manual(values = c("Cluster" = "#16182A", "Cluster" = "grey")) +
  ylab("Fraction") + ggtitle("159 Clustered samples")
ggsave("elastic_net_binomial_models/mutation_enrichment_clustered_samples_cluster_3.pdf", height = 7, width = 7)

```







Adding drug response data


```{r}
drug_data <- load.functional.data()[["Long-form functional"]] %>% 
  select(Barcode.ID, Inhibitor, AUC) %>%
  filter(Inhibitor %in% c("Sorafenib", "Venetoclax", "Quizartinib (AC220)", "Trametinib (GSK1120212)", "Gilteritinib")) %>%
  unique() 

drug_mat <- pivot_wider(drug_data, names_from = "Inhibitor", values_from = "AUC")
meta_c_new <- left_join(meta_c_new, drug_mat, by = "Barcode.ID")
meta_c_train <- left_join(meta_c_train, drug_mat, by = "Barcode.ID")

```



Venetoclax, Sorafenib, Trametinib (GSK1120212)



```{r}

adjust_c = 1
alpha_c = 0.2

ggplot(meta_c_train, aes(x = Venetoclax, fill = `Cluster 3`)) + 
  geom_density(alpha = alpha_c, adjust = adjust_c) + 
  ggtitle("Venetoclax, 159 clustered samples")
ggplot(meta_c_new %>% filter(conf == "OK"), aes(x = Venetoclax, fill = `Cluster 3`)) + 
  geom_density(alpha = alpha_c, adjust = adjust_c) + 
  ggtitle("Venetoclax, new samples")

ggplot(meta_c_train, aes(x = Sorafenib, fill = `Cluster 3`)) + 
  geom_density(alpha = alpha_c, adjust = adjust_c) + 
  ggtitle("Sorafenib, 159 clustered samples")
ggplot(meta_c_new %>% filter(conf == "OK"), aes(x = Sorafenib, fill = `Cluster 3`)) + 
  geom_density(alpha = alpha_c, adjust = adjust_c) + 
  ggtitle("Sorafenib, new samples")

ggplot(meta_c_train, aes(x = `Trametinib (GSK1120212)`, fill = `Cluster 3`)) + 
  geom_density(alpha = alpha_c, adjust = adjust_c) + 
  ggtitle("Trametinib (GSK1120212), 159 clustered samples")
ggplot(meta_c_new %>% filter(conf == "OK"), aes(x = `Trametinib (GSK1120212)`, fill = `Cluster 3`)) + 
  geom_density(alpha = alpha_c, adjust = adjust_c) + 
  ggtitle("Trametinib (GSK1120212), new samples")

```


```{r}
table_show <- meta_c_new %>%
  filter(conf == "OK") %>%
  mutate(Cluster = case_when(assgn == "1" ~ "Cluster 1",
                             assgn == "2" ~ "Cluster 2",
                             assgn == "3" ~ "Cluster 3",
                             assgn == "4" ~ "Cluster 4",
                             assgn == "5" ~ "Cluster 5"))
table(table_show$Cluster)

```




```{r}
table_show <- meta_c_train %>%
  mutate(Cluster = case_when(k.5 == "1" ~ "Cluster 1",
                             k.5 == "2" ~ "Cluster 2",
                             k.5 == "3" ~ "Cluster 3",
                             k.5 == "4" ~ "Cluster 4",
                             k.5 == "5" ~ "Cluster 5"))
table(table_show$Cluster)

```



