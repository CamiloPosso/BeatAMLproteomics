---
title: "K = 4 multinomial predictions"
author: "Camilo Posso"
date: "04/27/2022"
output: 
  html_document:
    code_folding: hide
    toc: true
editor_options: 
  chunk_output_type: inline
---

## Goal




```{r include=FALSE}
library(dplyr)
library(ggplot2)
library(kableExtra)
library(glmnet)
library(survminer)
library(survival)
library(gridExtra)
library(grid)

source("../NMF_helper.R")
source("../cluster_model_helper.R")

```


Loading model results.


```{r}
all_results <- readRDS("enet_multinomial_data/elastic_net_multinomial_results_k_5.RDS")
all_bounds <- readRDS("enet_multinomial_data/all_bounds.RDS")
bound_mult <- all_bounds$bound_mult

```



Here we train a prediction model using the full dataset and the best performing hyperparameters
to extend cluster 5 (good prognosis) to the 51 unclustered samples.


```{r}

make_prediction <- function(chosen_alpha, data_type, robust){
  if (data_type == "Global"){
    data_mat <- global_mat_train
    data_mat_test <- global_mat_test
    data_mat_full <- global.data %>%
      dplyr::rename(feature = Gene) %>%
      filter(feature %in% global_features) %>%
      pivot_wider(names_from = Barcode.ID, 
                  values_from = LogRatio) %>% 
      as.data.frame()
    rownames(data_mat_full) <- data_mat_full$feature
    data_mat_full <- data_mat_full[, -1] %>% as.matrix()
  } else if (data_type == "Phospho"){
    data_mat <- phospho_mat_train
    data_mat_test <- phospho_mat_test
    data_mat_full <- phospho.data %>%
      select(Barcode.ID, SiteID, LogRatio) %>%
      dplyr::rename(feature = SiteID) %>%
      filter(feature %in% phospho_features) %>%
      pivot_wider(names_from = Barcode.ID, 
                  values_from = LogRatio) %>% 
      as.data.frame()
    rownames(data_mat_full) <- data_mat_full$feature
    data_mat_full <- data_mat_full[, -1] %>% as.matrix()
  }
  
  xx <- all_results[[data_type]]
  data_mat_full <- sweep(data_mat_full, 1, apply(data_mat_full, 1, mean), FUN = '-')
  data_mat_full <- sweep(data_mat_full, 1, apply(data_mat_full, 1, sd), FUN = '/')
  
  ## Key line
  if (robust){
    data_mat_test <- data_mat_full[, colnames(data_mat_test)]
  }
  
  min_bounds <- all_bounds[[paste0("min_bounds_", data_type)]]
  max_bounds <- all_bounds[[paste0("max_bounds_", data_type)]]
  min_lambda <- min_bounds[as.character(chosen_alpha), ]
  max_lambda <- max_bounds[as.character(chosen_alpha), ]
  allowed_lambda <- (as.numeric(rownames(xx)) < max_lambda) & 
                    (as.numeric(rownames(xx)) > min_lambda)
  
  xx <- xx[allowed_lambda, ]
  col_name <- paste("alpha =", chosen_alpha)
  chosen_lambda <- rownames(xx)[[which.min(xx[[col_name]])]] %>%
    as.numeric()
  print(chosen_lambda)
  
  cluster_lab <- enet_meta %>%
    mutate(cluster_lab = paste("Cluster", k.5)) %>%
    pull(cluster_lab) %>%
    as.factor()
  names(cluster_lab) <- enet_meta$Barcode.ID
  cluster_lab <- cluster_lab[colnames(data_mat)]

  model <- glmnet(x = t(data_mat),
                  y = cluster_lab,
                  family = 'multinomial',
                  alpha = chosen_alpha,
                  lambda = chosen_lambda)
  
  cluster_predictions <- predict(model, s = chosen_lambda, 
                                 newx = t(data_mat_test), 
                                 type = "response")[, , 1] %>% as.data.frame()
  colnames(cluster_predictions) <- paste("New", colnames(cluster_predictions))
  cluster_predictions$max_new <- apply(cluster_predictions, 1, max) %>% unname()
  cluster_predictions$pred_cluster <- predict(model, s = chosen_lambda, 
                                              newx = t(data_mat_test), 
                                              type = "class") 
  cluster_predictions$Barcode.ID <- rownames(cluster_predictions)
  
  cluster_predictions_full <- predict(model, s = chosen_lambda, 
                                      newx = t(data_mat_full), 
                                      type = "response")[, , 1] %>% as.data.frame()
  colnames(cluster_predictions_full) <- paste("Full", colnames(cluster_predictions_full))
  cluster_predictions_full$max_full <- apply(cluster_predictions_full, 1, max) %>% unname()
  cluster_predictions_full$pred_cluster_v2 <- predict(model, s = chosen_lambda, 
                                                      newx = t(data_mat_full), 
                                                      type = "class")
  cluster_predictions_full$Barcode.ID <- rownames(cluster_predictions_full)
  
  out <- full_join(cluster_predictions, cluster_predictions_full, by = "Barcode.ID")
  return(out)
}


make_prediction_plot <- function(chosen_alpha, data_type, confidence_cutoff = 0.40, robust = TRUE){
  cluster_predictions <- make_prediction(chosen_alpha, data_type, robust) %>%
    mutate(pred_cluster = sub("Cluster ", "", pred_cluster),
           pred_cluster_v2 = sub("Cluster ", "", pred_cluster_v2))
  if (robust){
    path_ending <- "_robust_normalization.pdf"
  } else {
    path_ending <- ".pdf"
  }
  
  meta_c <- left_join(meta, cluster_assignments, by = "Barcode.ID") %>%
    mutate(overallSurvival = as.numeric(overallSurvival),
           k.5 = as.character(k.5)) %>%
    left_join(cluster_predictions, by = "Barcode.ID")
  rownames(meta_c) <- meta_c$Barcode.ID
  
  meta_c_new <- meta_c %>%
      filter(is.na(k.5)) %>%
    mutate(conf = case_when(max_new <= confidence_cutoff ~ "Low confidence",
                            TRUE ~ "OK")) %>%
    dplyr::rename(Cluster = pred_cluster)
  meta_c_plot <- meta_c_new %>%
    filter(conf == "OK")
  meta_c_train <- meta_c %>%
    filter(!is.na(k.5)) %>%
    dplyr::rename(Cluster = k.5)
  
  plot_title <- paste0("Predicting on 51 new samples, conf > ", 
                       confidence_cutoff, "(", nrow(meta_c_plot), " samples)")
  color_palette <- c("1" = subtype_colors[[1]],
                     "2" = subtype_colors[[2]],
                     "3" = subtype_colors[[3]],
                     "4" = subtype_colors[[4]],
                     "5" = subtype_colors[[5]])
  
  sfit <- survfit(Surv(overallSurvival, vitalStatus) ~ Cluster, data = meta_c_train)
  p1 <- ggsurvplot(sfit, color = "Cluster", data = meta_c_train, 
                   palette = color_palette)$plot +
          theme(legend.text = element_text(size = 12, color = "black"),
                legend.title = element_text(size = 12, color = "black")) + 
          ggtitle("159 Clustered samples")
  
  meta_c$Cluster <- meta_c$pred_cluster_v2
  sfit <- survfit(Surv(overallSurvival, vitalStatus) ~ Cluster, data = meta_c)
  p2 <- ggsurvplot(sfit, color = "Cluster", data = meta_c, 
                   palette = color_palette)$plot +
          theme(legend.text = element_text(size = 12, color = "black"),
                legend.title = element_text(size = 12, color = "black")) + 
          ggtitle("Predicting on all 210 samples")
  
  sfit <- survfit(Surv(overallSurvival, vitalStatus) ~ Cluster, data = meta_c_plot)
  p3 <- ggsurvplot(sfit, color = "Cluster", data = meta_c_plot,
                   palette = color_palette)$plot +
          theme(legend.text = element_text(size = 12, color = "black"),
                legend.title = element_text(size = 12, color = "black")) +
          ggtitle(plot_title)
  
  sfit <- survfit(Surv(overallSurvival, vitalStatus) ~ Cluster, data = meta_c_new)
  p4 <- ggsurvplot(sfit, color = "Cluster", data = meta_c_new,
                   palette = color_palette)$plot +
          theme(legend.text = element_text(size = 12, color = "black"),
                legend.title = element_text(size = 12, color = "black")) + 
          ggtitle("Predicting on 51 new samples")
  
  p_all <- arrangeGrob(p1, p2, p3, p4, ncol = 2, nrow = 2,
                       top = textGrob(paste0("Survival plots, ", data_type, ", alpha = ", chosen_alpha), 
                                      gp = gpar(fontsize = 20)))
  ggsave(paste0("enet_multinomial_data/predicted_survival_", 
                data_type, "_", chosen_alpha, path_ending), 
         width = 16, height = 12, p_all)
}

```



```{r eval=FALSE, include=FALSE}
lapply(c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0), function(chosen_alpha){
  make_prediction_plot(chosen_alpha, "Global", robust = TRUE)
  make_prediction_plot(chosen_alpha, "Phospho", robust = TRUE)
  make_prediction_plot(chosen_alpha, "Global", robust = FALSE)
  make_prediction_plot(chosen_alpha, "Phospho", robust = FALSE)
})

```



Mutation status 


```{r}
all_mutation_data <- load_mutational_sample_data()
mutation_data <- all_mutation_data %>%
  mutate(value = TRUE) %>%
  pivot_wider(names_from = Gene, values_from = value, values_fn = any)
mutation_data <- mutation_data[, c("Barcode.ID", "NPM1", "NPM1_clinical")]

meta_c_new <- meta_c_new %>%
  left_join(mutation_data, by = "Barcode.ID") %>%
  mutate(`Cluster 3` = case_when(assgn == "3" ~ "Cluster 3",
                                        TRUE ~ "Not Cluster 3")) %>%
  mutate(FLT3 = case_when(FLT3.ITD == "TRUE" ~ TRUE,
                          TRUE ~ FALSE),
         NPM1 = case_when(!is.na(NPM1) ~ NPM1,
                          TRUE ~ FALSE),
         NPM1_clinical = case_when(!is.na(NPM1_clinical) ~ NPM1_clinical,
                                   TRUE ~ FALSE))

meta_c_train <- meta_c %>%
  filter(!is.na(k.5)) %>%
  left_join(mutation_data, by = "Barcode.ID") %>%
  mutate(`Cluster 3` = case_when(k.5 == "3" ~ "Cluster 3",
                                 TRUE ~ "Not Cluster 3")) %>%
  mutate(FLT3 = case_when(FLT3.ITD == "TRUE" ~ TRUE,
                          TRUE ~ FALSE),
         NPM1 = case_when(!is.na(NPM1) ~ NPM1,
                          TRUE ~ FALSE),
         NPM1_clinical = case_when(!is.na(NPM1_clinical) ~ NPM1_clinical,
                                   TRUE ~ FALSE))

```



Get enrichment of NPM1, FLT3 within predicted cluster.



```{r}
sample_categories_new <- meta_c_new %>%
  filter(conf == "OK") %>%
  select(Barcode.ID, FLT3, NPM1, NPM1_clinical)

assignments_new <- meta_c_new %>%
  filter(conf == "OK") %>%
  select(Barcode.ID, assgn) %>%
  dplyr::rename(Cluster = assgn)

sample_categories_train <- meta_c_train %>%
  select(Barcode.ID, FLT3, NPM1, NPM1_clinical)

assignments_train <- meta_c_train %>%
  select(Barcode.ID, k.5) %>%
  dplyr::rename(Cluster = k.5)


get_enrichment <- function(sample_categories, assignments, log.scale = FALSE) {
  k = length(unique(assignments$Cluster))
  
  sample_categories <- sample_categories %>%
    filter(rownames(.) %in% rownames(assignments)) %>%
    left_join(assignments, by = "Barcode.ID") %>%
    column_to_rownames("Barcode.ID") %>% 
    as.data.frame()
  
  categories <- sample_categories %>%
    select(-Cluster) %>%
    colnames()
  
  out <- lapply(categories, function(category){
    
    p.values <- lapply(1:k, function(i){
      cluster.df <- sample_categories %>%
        mutate(Cluster = case_when(Cluster == i ~ TRUE,
                                   TRUE ~ FALSE)) %>%
        mutate(Cluster = as.factor(Cluster))
      dat <- table(cluster.df[[category]], cluster.df$Cluster)
      background_dist <- apply(dat, 1, sum)
      background_prop <- background_dist[[2]]/(background_dist[[2]] + background_dist[[1]])
      cluster_prop <- dat[2, 2]/(dat[1, 2] + dat[2, 2])
      p_value <- fisher.test(dat, workspace = 2e8, alternative = "greater")$p.value
      if (log.scale) {
        p.values <- -log10(p.values)
      } else {
        p.values <- p.values
      }
      xx <- data.frame(background_prop, cluster_prop, p_value)
      colnames(xx) <- c(paste("Background", category, "positive fraction"),
                        paste("Cluster", category, "positive fraction"),
                        paste("Enrichment", category, "p-value"))
      rownames(xx) <- paste("Cluster", i)
      return(xx)
    }) %>% do.call("rbind", .)
    
    
    
  }) %>% do.call(cbind, .) %>% 
    as.data.frame()
}

mutation_enrichment_new <- get_enrichment(sample_categories_new, assignments_new)
mutation_enrichment_train <- get_enrichment(sample_categories_train, assignments_train)

# write.table(mutation_enrichment_new, "enet_binomial_data/binomial_predicted_clusters_mutation_enrichment.txt", 
#             sep = "\t", quote = F)
# write.table(mutation_enrichment_train, "enet_binomial_data/training_samples_mutation_enrichment.txt", 
#             sep = "\t", quote = F)
# 
# upload.plot("enet_binomial_data/binomial_predicted_clusters_mutation_enrichment.txt", parentId = "syn29612385")
# upload.plot("enet_binomial_data/training_samples_mutation_enrichment.txt", parentId = "syn29612385")

```


Summary of predicted cluster mutation enrichment.


```{r}

mutation_summary <- function(mutation, setting){
  if (setting == "training"){
    plot_df <- mutation_enrichment_train
    plot_title <- paste("Fraction of", mutation, 
                        "samples, 159 combined cohort clusters")
    plot_path <- paste0("enet_binomial_data/fraction_of_", mutation, "_samples_combined_cohort_clusters.pdf")
  } else if (setting == "predicted"){
    plot_df <- mutation_enrichment_new
    plot_title <- paste("Fraction of", mutation, 
                        "samples, predicted clusters")
    plot_path <- paste0("enet_binomial_data/fraction_of_", mutation, "_samples_predicted_clusters.pdf")
  }
  
  plot_df <- plot_df %>%
    select(contains(paste0(mutation, " "))) %>%
    mutate(Cluster = rownames(.)) %>%
    pivot_longer(-Cluster, )
  background_prop <- plot_df %>%
    filter(grepl("Background", name)) %>%
    pull(value) %>%
    unique()
  p_values <- plot_df %>%
    filter(grepl("Enrichment", name)) %>%
    pull(value)
  plot_df <- plot_df %>%
    filter(grepl("Cluster", name)) %>%
    dplyr::rename(Fraction = value)
  p_labels <- format(p_values, digits = 3)
  
  ggplot(plot_df, aes(x = Cluster, y = Fraction, fill = Cluster)) + 
    geom_bar(stat = 'identity', width = 0.3) + 
    ylim(-0.03, 1) + ggtitle(plot_title) + geom_hline(yintercept = background_prop, color = "black") +
    geom_text(x = 2.5, y = 0.9, label = paste("Fraction", mutation, "in background")) +
    geom_segment(aes(x = 2.5, y = 0.85, xend = 2.5, yend = background_prop + 0.1),
                    arrow = arrow(length = unit(0.5, "cm")), color = "black") +
    scale_fill_manual(values = subtype_colors, labels = p_labels, "Enrichment p-value") +
    theme(legend.text = element_text(size = 13))
  ggsave(plot_path)
}
  
mutation_summary("FLT3", "training")
mutation_summary("FLT3", "predicted")
mutation_summary("NPM1", "training")
mutation_summary("NPM1", "predicted")
mutation_summary("NPM1_clinical", "training")
mutation_summary("NPM1_clinical", "predicted")

```


Adding drug response data


```{r}
drug_data <- load.functional.data()[["Long-form functional"]] %>% 
  select(Barcode.ID, Inhibitor, AUC) %>%
  filter(Inhibitor %in% c("Sorafenib", "Venetoclax", "Quizartinib (AC220)", "Trametinib (GSK1120212)", "Gilteritinib")) %>%
  unique() 

drug_mat <- pivot_wider(drug_data, names_from = "Inhibitor", values_from = "AUC")
drug_meta_new <- left_join(meta_c_new[, c("Barcode.ID", "assgn", "conf")], drug_mat, by = "Barcode.ID") %>%
  filter(conf == "OK") %>%
  dplyr::rename(Cluster = assgn)
drug_meta_train <- left_join(meta_c_train[, c("Barcode.ID", "k.5")], drug_mat, by = "Barcode.ID") %>%
  dplyr::rename(Cluster = k.5)

```

```{r}
drug_response_cluster <- function(chosen_drug, setting){
  if (setting == "training"){
    plot_df <- drug_meta_train
  } else if (setting == "predicted"){
    plot_df <- drug_meta_new
  }
  
  ggplot(plot_df, aes_string(x = chosen_drug, fill = "Cluster")) + 
    geom_density(alpha = 0.2, adjust = 1) + 
    ggtitle("Venetoclax, 159 clustered samples")
  
}

drug_response_cluster("Venetoclax", "predicted")

```

Venetoclax, Sorafenib, Trametinib (GSK1120212)



```{r}

adjust_c = 1
alpha_c = 0.2

ggplot(meta_c_train, aes(x = Venetoclax, fill = `Cluster 3`)) + 
  geom_density(alpha = alpha_c, adjust = adjust_c) + 
  ggtitle("Venetoclax, 159 clustered samples")
ggplot(meta_c_new %>% filter(conf == "OK"), aes(x = Venetoclax, fill = `Cluster 3`)) + 
  geom_density(alpha = alpha_c, adjust = adjust_c) + 
  ggtitle("Venetoclax, new samples")

ggplot(meta_c_train, aes(x = Sorafenib, fill = `Cluster 3`)) + 
  geom_density(alpha = alpha_c, adjust = adjust_c) + 
  ggtitle("Sorafenib, 159 clustered samples")
ggplot(meta_c_new %>% filter(conf == "OK"), aes(x = Sorafenib, fill = `Cluster 3`)) + 
  geom_density(alpha = alpha_c, adjust = adjust_c) + 
  ggtitle("Sorafenib, new samples")

ggplot(meta_c_train, aes(x = `Trametinib (GSK1120212)`, fill = `Cluster 3`)) + 
  geom_density(alpha = alpha_c, adjust = adjust_c) + 
  ggtitle("Trametinib (GSK1120212), 159 clustered samples")
ggplot(meta_c_new %>% filter(conf == "OK"), aes(x = `Trametinib (GSK1120212)`, fill = `Cluster 3`)) + 
  geom_density(alpha = alpha_c, adjust = adjust_c) + 
  ggtitle("Trametinib (GSK1120212), new samples")

```


```{r}
table_show <- meta_c_new %>%
  filter(conf == "OK") %>%
  mutate(Cluster = case_when(assgn == "1" ~ "Cluster 1",
                             assgn == "2" ~ "Cluster 2",
                             assgn == "3" ~ "Cluster 3",
                             assgn == "4" ~ "Cluster 4",
                             assgn == "5" ~ "Cluster 5"))
table(table_show$Cluster)

```




```{r}
table_show <- meta_c_train %>%
  mutate(Cluster = case_when(k.5 == "1" ~ "Cluster 1",
                             k.5 == "2" ~ "Cluster 2",
                             k.5 == "3" ~ "Cluster 3",
                             k.5 == "4" ~ "Cluster 4",
                             k.5 == "5" ~ "Cluster 5"))
table(table_show$Cluster)

```



