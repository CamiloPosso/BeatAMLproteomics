---
title: "Mutational analysis: differential expression v1"
author: "Camilo Posso"
date: "02/02/2022"
output: 
  html_document:
    code_folding: hide
    toc: true
editor_options: 
  chunk_output_type: inline
---

## Mutation summary


Below we have a quick summary of the mutational data from the WES dataset. 


```{r include=FALSE}
library(dplyr)
library(ggplot2)
library(kableExtra)


source("../util/synapseUtil.R")
source("../util/loading_data.R")
source("../util/differential_expression_helper.R")


load("../Misc/load.combined.data 1-20-2022.RData")
samples <- global.data %>%
  pull(Barcode.ID) %>% unique()

total_mutations <- WES.data %>%
  pull(Gene) %>% unique()

```



```{r}

## Mutations with at least 4 patients having said mutation
WES_reduced <- WES.data %>%
  filter(Barcode.ID %in% samples) %>% 
  group_by(Barcode.ID, Gene) %>%
  slice(1) %>%
  ungroup(Barcode.ID, Gene)

mutation_count <- WES_reduced %>%
  group_by(Gene) %>%
  summarise(n = n())

mutations <-  mutation_count %>%
  filter(n > 3) %>%
  pull(Gene)

WES_samples <- WES_reduced %>%
  group_by(Gene) %>%
  mutate(n = n()) %>%
  arrange(-n) %>%
  pull(Barcode.ID) %>%
  unique()

WES_reduced <- WES_reduced %>%
  mutate(value = 1) %>%
  select(Barcode.ID, Gene, value)


m.WES <- make.msnset(WES_reduced, "Gene", "Barcode.ID", "value", meta)  
mat <- exprs(m.WES)[, WES_samples]
mat[is.na(mat)] <- 0

```


Of the `r length(total_mutations)` mutations recorded in at least one sample, `r length(mutations)`
of them are present in at least 4 samples. Below we summarize the mutational data for these
`r length(mutations)` mutations using a heatmap. Note the columns represent samples, while the
light beige color denotes mutation.


```{r}

  
pheatmap(mat[mutations, ], color = c("#16182A", "#F5E9D9"), 
         legend = FALSE, show_colnames = FALSE)


```


## Differential Expression

Focusing on any one of the `r length(mutations)`, say \(\mu\), we can ask. Which phospho-sites 
are differentially expressed in \(\mu\) mutated samples vs non mutated samples? What if we use
global or RNA data? Below we collect this information into a table.


```{r include=FALSE}

m.RNA <- make.msnset(RNA.data, feature.col = "Gene",
                     value.col = "RNA counts", metadata = meta)
m.global <- make.msnset(global.data, feature.col = "Gene",
                        value.col = "LogRatio", metadata = meta)
m.phospho <- make.msnset(phospho.data, feature.col = "SiteID",
                         value.col = "LogRatio", metadata = meta)


datasets <- list(m.global, m.phospho, m.RNA)
names(datasets) <- c("global", "phospho", "RNA")

differential_expression_results <- lapply(mutations, check_diff_exp_individual, WES.data, datasets)

summary_table <- lapply(differential_expression_results, function(xx){xx[[1]]}) %>% do.call("rbind", .)


```



```{r}
library(DT)
DT::datatable(summary_table)
```


```{r eval=FALSE, include=FALSE}
### Run this to make all the heatmaps. A few will fail, due to the exactly one feature
### being selected to plot.
dataset_names <- names(datasets)

for (i in 1:length(differential_expression_results)){
  mutation = differential_expression_results[[i]][[1]]$mutation[[1]]
  diff_exp <- differential_expression_results[[i]][[2]]
  
  
  features <- lapply(1:3, function(j){
    diff_exp %>%
      filter(datatype == dataset_names[[j]]) %>%
      head(20) %>%
      pull(feature)
  })
  
  for (j in 1:3){
    if (length(features[[j]]) > 0){
      try(plot_diffexp_heatmap(mutation, WES.data, datasets[j], features[[j]], suffix = dataset_names[[j]]))
    }
  }
}

```


## Summarizing the top mutations


Finally, below we summarize a few of the mutations with the largest number of significant 
differentially expressed features. To summarize a mutation, we plot a heatmap of the global, 
phospho, and RNA expressions for those differentially expressed features. 


At the top, we find an indicator of the mutation status of the samples, showing whether
the samples exhibit that particular mutation in question. Finally, in order to make comparisons 
of mutated vs non mutated samples easier, we have normalized the data prior to plotting on the heatmaps.


### NPM1


#### Differentially expressed in Global


```{r}
knitr::include_graphics("differentially_expressed_features_in_NPM1_mutated_samples_global.png")

```


#### Differentially expressed in Phospho


```{r}
knitr::include_graphics("differentially_expressed_features_in_NPM1_mutated_samples_phospho.png")

```


#### Differentially expressed in RNA


```{r}
knitr::include_graphics("differentially_expressed_features_in_NPM1_mutated_samples_RNA.png")

```




### TP53


#### Differentially expressed in Global


```{r}
knitr::include_graphics("differentially_expressed_features_in_TP53_mutated_samples_global.png")

```


#### Differentially expressed in Phospho


```{r}
knitr::include_graphics("differentially_expressed_features_in_TP53_mutated_samples_phospho.png")

```


#### Differentially expressed in RNA


```{r}
knitr::include_graphics("differentially_expressed_features_in_TP53_mutated_samples_RNA.png")

```










