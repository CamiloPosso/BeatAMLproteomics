---
title: "Figure 1 Data Summary"
author: "Sara Gosline"
date: "11/05/2021"
output: html_document
editor_options: 
  chunk_output_type: inline
---

## Get Data
This calls the standard data loading function that exists at `../beatAMLdata.R`. Once it is loaded it should not have to be reloaded. 

```{r setup, include=FALSE,message=FALSE}
library(amlresistancenetworks)
library(dplyr)
library(ggplot2)
library(openxlsx)
library(tidyr)
source("../../util/synapseUtil.R")
source("../../util/loading_data.R")

load.combined.data()

```


```{r compatibility chunk}
## Here we follow define analogous objects to auc.dat, full.pats, etc 
## to get started on running this script which was written within a 
## different context.

combined$`AML sample` <- combined$Barcode.ID

## slice(1) is needed, since a particular drug (Inhibitor) can belong to more
## than one family, so some AUC's are duplicated.
auc.dat <- functional.data %>%
  filter(!is.na(family)) %>%
  group_by(Inhibitor, Barcode.ID) %>%
  slice(1) %>%
  ungroup(Inhibitor, Barcode.ID) %>%
  dplyr::rename(`AML sample` = Barcode.ID,
                Condition = Inhibitor)

auc.dat.fam <- functional.data.sensitive.family %>%
  dplyr::rename(`AML sample` = Barcode.ID,
                Condition = Inhibitor)
  
pat.phos <- phospho.data %>%
  select(Barcode.ID, Gene, SiteID, LogRatio) %>%
  dplyr::rename(Sample = Barcode.ID,
                site = SiteID,
                LogFoldChange = LogRatio)

## May not be needed
# pat.data 

## Note that functional data is selecting only drugs that at least
## 10% of samples are sensitive to, where AUC < 100 is the condition for `sensitive`.
num.drugs <- auc.dat %>%
  select(`AML sample`, Condition) %>%
  unique() %>%
  group_by(`AML sample`) %>%
  summarise(numDrugs = n())

summary <- sample.summary %>%
  dplyr::rename(`AML sample` = Barcode.ID) %>%
  merge(num.drugs)
rownames(summary) <- summary$`AML sample`

## The function plotAllAUCs needs the dat.summ table. 
## It makes dat.summ normally from passed data,
## But it's easier to pass it here instead. This needs a very 
## small modification of plotAllAUCs. Other ways of getting around 
## this require changing the original function too much. 
## The current change is minimal and should not break any previous code.
dat.summ <- sample.summary %>%
  dplyr::rename(`AML sample` = Barcode.ID,
                mutations = WES,
                proteins = Global,
                phosphoSite = Phospho)

write.xlsx(summary, "patientSummaryTab.xlsx")
```

## Data Summary

The goal fo this markdown is to summarize the BeatAML data that we have so far. Patient summary, summary of AUC value, and general proteomics/protein data. Here we have the data for

```{r histogram and heatmaps drug level, message=FALSE}
## Note: plotAllAUCs fills in NA with zeros.
res <- auc.dat %>%
  plotAllAUCs(pat.data,drug.metric='AUC',drug.column='Condition', 
              dat.summ = dat.summ)

full.drg<-res%>%
  tibble::rownames_to_column("AML sample")%>%
  left_join(auc.dat)%>%
  select(`AML sample`,Drug='Condition',proteins,RNA,mutations)%>%
  distinct()%>%
  group_by(Drug)%>%
  summarize(`Patients with proteomics`=length(which(proteins==TRUE)),
            `Patients with mRNA`=length(which(RNA==TRUE)),
            `Patients with Mutations`=length(which(mutations==TRUE)))
  
knitr::kable(full.drg)
write.csv(full.drg,'table1.csv')
write.csv(res,'supp_table1.csv')
  
```

Since many of the patients are incomplete, we save a second version of the data that has only those 'complete' datasets.

```{r full patients}
## full pats is the set of samples with all types of data (here total of 4, same as now).
full.pats <- sample.summary %>%
  mutate(`All types` = Global & Phospho & RNA & WES) %>%
  filter(`All types`)
  
## These don't seem to be used
# red.auc<-auc.dat%>%subset(`AML sample`%in%full.pats$`AML sample`)
# red.dat<-pat.data%>%subset(`AML sample`%in%full.pats$`AML sample`)
# red.phos<-pat.phos%>%subset(Sample%in%full.pats$`AML sample`)

knitr::kable(summary[full.pats$Barcode.ID,])
```

## Drug Family summary

We can also collate information by drug family to increase power. 


```{r histogram and heatmaps drug level, message=FALSE}
## AUC values for sample + family combination are averaged together.
## Note: plotAllAUCs fills in NA with zeros when making heatmaps.
res<-auc.dat.fam %>%
  plotAllAUCs(pat.data, drug.metric='AUC', drug.column='family', 
              dat.summ = dat.summ)

full.drg<-res%>%
  tibble::rownames_to_column("AML sample")%>%
  left_join(auc.dat.fam)%>%
  select(`AML sample`,Drug='family',proteins,RNA,mutations)%>%
  distinct()%>%
  group_by(Drug)%>%
  summarize(`Patients with proteomics`=length(which(proteins==TRUE)),`Patients with mRNA`=length(which(RNA==TRUE)),`Patients with
            Mutations`=length(which(mutations==TRUE)))

knitr::kable(full.drg)
write.csv(full.drg,'fam_table1.csv')
write.csv(res,'fam_supp_table1.csv')

```


## Protein/mRNA/phosphosite correlation values
how well do these samples correlate across all samples?


### mRNA/protein


```{r, prot cors,warning=FALSE,message=FALSE}

xx <- combined %>%
  select(Barcode.ID, Gene, globalLogRatio, `RNA counts`) %>%
  filter(!is.na(`RNA counts`) & !is.na(globalLogRatio)) %>%
  distinct() 

mp <- xx %>% 
  group_by(Barcode.ID) %>%
  summarize(corval = cor(globalLogRatio, `RNA counts`, method='spearman', use='pairwise.complete.obs'))

DT::datatable(mp)

mpp <- xx %>%
  ggplot(aes(x = globalLogRatio, y = `RNA counts`, col = Barcode.ID)) + geom_point() + 
  scale_color_viridis_d() + ggtitle('mRNA/Protein correlation') + theme(legend.position="none")


```




### protein/phosphosite

```{r prot phospho cor, warning=FALSE}
xx <- combined %>%
  select(Barcode.ID, Gene, globalLogRatio, phosphoLogRatio, wesMutation) %>%
  filter(!is.na(phosphoLogRatio) & !is.na(globalLogRatio)) %>%
  distinct() 

mp <- xx %>% 
  group_by(Barcode.ID) %>%
  summarize(corval = cor(globalLogRatio, phosphoLogRatio, method='spearman', use='pairwise.complete.obs'))

DT::datatable(mp)

mpp <- xx %>%
  ggplot(aes(x = globalLogRatio, y = phosphoLogRatio, col = Barcode.ID)) + geom_point() + 
  scale_color_viridis_d() + ggtitle('Phosphosite/Protein correlation') + theme(legend.position="none")

```


### gene/mRNA

### gene/protein



## FLT3 pathway visualization

Let's see how each data type is represented across the FLT3 pathway

```{r flt3pathway, message=F,warning=F}
library(ggplot2)
flt3prots<-c("FLT3","FYN","GAB2","GRB2","HRAS",'HCK','KRAS','NRAS','PIK3R1','PTPN11','SOS1')


quiz.auc <- auc.dat %>%
#  subset(`AML sample`%in%flt3.pats$`AML sample`)%>%
  dplyr::select(Condition,AUC,'AML sample') %>%
  subset(Condition=='Quizartinib (AC220)')

flt3.pats <- combined %>%
  subset(Gene %in% flt3prots) %>%
  inner_join(quiz.auc) %>%
  select(`AML sample`, everything(), -Barcode.ID) %>%
  dplyr::rename(site = SiteID,
                proteinLevels = globalLogRatio,
                Phosphosite = phosphoLogRatio,
                mRNALevels = `RNA counts`,
                binaryMutations = wesMutation)
  #subset(`AML sample`%in%auc.dat$`AML sample`)

genecors <- flt3.pats %>%
  group_by(Gene) %>%
  summarize(tcor = cor(mRNALevels, proteinLevels, use='pairwise.complete.obs', method='spearman'))

phoscors <- flt3.pats %>%
  group_by(Gene) %>%
  summarize(pcor = cor(Phosphosite, proteinLevels, use='pairwise.complete.obs', method='spearman'))

genecors <- genecors %>% left_join(phoscors)

write.csv(genecors, file = 'flt3CorVals.csv')

DT::datatable(genecors)

cor.genes <- genecors$Gene#$subset(genecors,abs(tcor)>0.25)$Gene

dotplots <- lapply(cor.genes, function(x)
  subset(flt3.pats, Gene == x) %>%
    # mutate(mRNALevels=log10(0.01+mRNALevels))%>% already log transformed.
    mutate(mutated = as.factor(binaryMutations)) %>%
    ggplot(aes(x = proteinLevels, y = mRNALevels, shape = mutated, color = AUC)) + 
    geom_point() + ggtitle(x)
)

p <- cowplot::plot_grid(plotlist=dotplots, ncol=2)
# p

ggsave('flt3_correlatedDotPlots.pdf',p,width=12,height=24)

annotes <- quiz.auc %>%
  pivot_wider(values_from = 'AUC', names_from = 'Condition', values_fn = list(AUC = mean)) %>%
  tibble::column_to_rownames('AML sample')

pat.order <- arrange(annotes, `Quizartinib (AC220)`) %>% rownames()

## get prot FILLING IN NAs WITH ZEROS!@
prot.mat <- flt3.pats %>%
  dplyr::select(Gene, `AML sample`, proteinLevels) %>%
  filter(!is.na(proteinLevels)) %>%
  pivot_wider(values_from = proteinLevels, names_from = `AML sample`, values_fill = 0.0,
              values_fn=list(proteinLevels = mean))%>%
  mutate(Gene=paste(Gene,'prot'))%>%
  tibble::column_to_rownames('Gene')

##get phospho FILLING IN NAs WITH ZEROS!@
ph.mat <- flt3.pats %>%
  dplyr::select(site, `AML sample`, Phosphosite) %>%
  filter(!is.na(Phosphosite)) %>%
  pivot_wider(values_from = Phosphosite, names_from = `AML sample`, values_fill = 0.0,
              values_fn = list(Phosphosite = mean)) %>%
  tibble::column_to_rownames('site')

## get mrna FILLING IN NAs WITH ZEROS!@
t.mat <- flt3.pats %>%
  dplyr::select(Gene, `AML sample`, mRNALevels) %>%
  filter(!is.na(mRNALevels)) %>%
  pivot_wider(values_from = mRNALevels, names_from = `AML sample`, values_fill = 0.0,
              values_fn = list(mRNALevels = mean)) %>%
  mutate(Gene = paste(Gene, 'mRNA')) %>%
  tibble::column_to_rownames('Gene')

## Already log transformed
# t.mat<-log10(0.01+t.mat)
missing=which(apply(t.mat,2,var)==0)

## No samples to be removed here
# t.mat<-t.mat[,-missing]

##get VAF
v.mat <- flt3.pats %>%
  subset(Gene %in% c("FLT3", "NRAS", "KRAS")) %>%
  select(Gene, `AML sample`, binaryMutations) %>%
  mutate(binaryMutations = case_when(binaryMutations == "1" ~ 1,
                                     binaryMutations == "0" ~ 0)) %>%
  pivot_wider(values_from = binaryMutations,names_from=`AML sample`,values_fill=0.0,
              values_fn=list(binaryMutations=max))%>%
  mutate(Gene=paste(Gene,'Gene'))%>%
  tibble::column_to_rownames('Gene')


flt3.vars <- t(v.mat) ##asave this for later so twe can add as ribbon to next figure
pat.order <- intersect(pat.order,colnames(t.mat))
fullmat <- rbind(prot.mat[,pat.order],t.mat[,pat.order],ph.mat[,pat.order])

fannotes<-cbind(Quizartinib=annotes[colnames(fullmat),],t(v.mat)[colnames(fullmat),])
#allz<-which(apply(fannotes,2,var)==0)
#fannotes<-fannotes[,-allz]

## mRNA values and phospho + protein values are not comparable (5 to 12 vs -2 to 2)
## so heatmaps look funky
pheatmap(fullmat,cluster_rows = FALSE, show_rownames = F)

pheatmap(fullmat[sort(rownames(fullmat)),],
         cluster_rows = FALSE,cellheight=12,
         clustering_distance_cols = 'correlation',
         cluster_cols = TRUE, file='combined_heatmap.pdf',
         annotation_col = as.data.frame(fannotes) ,height=15, show_colnames = F)

pheatmap(as.matrix(prot.mat[,rownames(fannotes)]),
         cluster_rows = TRUE,cellheight=12,
        # clustering_distance_cols = 'correlation',
         cluster_cols = FALSE, file='prot_heatmap.pdf',
         annotation_col = as.data.frame(fannotes), show_colnames = F)
pheatmap(ph.mat[,rownames(fannotes)],
         cluster_rows = TRUE,cellheight=12,
         #clustering_distance_cols = 'correlation',
         cluster_cols = FALSE, file='phos_heatmap.pdf',
         annotation_col = as.data.frame(fannotes), show_colnames = F)
pheatmap(t.mat[,rownames(fannotes)],
         cluster_rows = TRUE,cellheight=12,
         #clustering_distance_cols = 'correlation',
         cluster_cols = FALSE, file='rna_heatmap.pdf',
         annotation_col = as.data.frame(fannotes), show_colnames = F)


dotplots<-lapply(subset(genecors,!is.na(pcor))$Gene,function(x)
  subset(flt3.pats,Gene==x)%>%
 #   mutate(mRNALevels=log10(0.01+mRNALevels))%>%
    mutate(mutated=as.factor(binaryMutations))%>%
    ggplot(aes(x=proteinLevels,y=Phosphosite,color=AUC,shape=site))+geom_point()+ggtitle(x)
)

p<-cowplot::plot_grid(plotlist=dotplots, ncol=2)
p
ggsave('flt3_phosphoDotPlots.pdf',p,width=12,height=12)

```

This shows that proteomic data is important to understanding the impact of targeted therapies. 


## ERK pathway visualization

Let's see how each data type is represented across the ERK1/2 pathway

```{r erkpathway, message=F,warning=F}
library(ggplot2)
erk1prots<-c("CDK1","MAP2K1","IL6","IL6R","IL6ST",'JAK1','JAK2','MAPK3','TYK2','PTPN11')


quiz.auc<-auc.dat%>%
#  subset(`AML sample`%in%erk1.pats$`AML sample`)%>%
  dplyr::select(Condition,AUC,'AML sample')%>%
  subset(Condition=='Trametinib (GSK1120212)')


erk1.pats <- combined %>%
  subset(Gene %in% erk1prots) %>%
  inner_join(quiz.auc) %>%
  select(`AML sample`, everything(), -Barcode.ID) %>%
  dplyr::rename(site = SiteID,
                proteinLevels = globalLogRatio,
                Phosphosite = phosphoLogRatio,
                mRNALevels = `RNA counts`,
                binaryMutations = wesMutation)

genecors<-erk1.pats%>%
  group_by(Gene)%>%
  summarize(tcor=cor(mRNALevels,proteinLevels,use='pairwise.complete.obs',method='spearman'))


phoscors<-erk1.pats%>%
  group_by(Gene)%>%
  summarize(pcor=cor(Phosphosite,proteinLevels,use='pairwise.complete.obs',method='spearman'))

genecors<-genecors%>%left_join(phoscors)

DT::datatable(genecors)
write.csv(genecors,file='erk1CorVals.csv')

cor.genes<-genecors$Gene#subset(genecors,abs(tcor)>0.1)$Gene

dotplots<-lapply(cor.genes,function(x)
  subset(erk1.pats,Gene==x)%>%
    mutate(mRNALevels=log10(0.01+mRNALevels))%>%
    mutate(mutated=as.factor(binaryMutations))%>%
    ggplot(aes(x=proteinLevels,y=mRNALevels,shape=mutated,color=AUC))+geom_point()+ggtitle(x)
)

p<-cowplot::plot_grid(plotlist=dotplots)
p

ggsave('erk1_correlatedDotPlots.pdf',p,width=12,height=12)

annotes<-quiz.auc%>%
  pivot_wider(values_from='AUC',names_from='Condition',values_fn=list(AUC=mean))%>%
  tibble::column_to_rownames('AML sample')

pat.order<-arrange(annotes, `Trametinib (GSK1120212)`)%>%rownames()

## get prot FILLING IN NAs WITH ZEROS!@
prot.mat <- erk1.pats %>%
  dplyr::select(Gene, `AML sample`, proteinLevels) %>%
  filter(!is.na(proteinLevels)) %>%
  pivot_wider(values_from = proteinLevels, names_from = `AML sample`, values_fill = 0.0,
              values_fn=list(proteinLevels = mean))%>%
  mutate(Gene=paste(Gene,'prot'))%>%
  tibble::column_to_rownames('Gene')

##get phospho FILLING IN NAs WITH ZEROS!@
ph.mat <- erk1.pats %>%
  dplyr::select(site, `AML sample`, Phosphosite) %>%
  filter(!is.na(Phosphosite)) %>%
  pivot_wider(values_from = Phosphosite, names_from = `AML sample`, values_fill = 0.0,
              values_fn = list(Phosphosite = mean)) %>%
  tibble::column_to_rownames('site')

## get mrna FILLING IN NAs WITH ZEROS!@
t.mat <- erk1.pats %>%
  dplyr::select(Gene, `AML sample`, mRNALevels) %>%
  filter(!is.na(mRNALevels)) %>%
  pivot_wider(values_from = mRNALevels, names_from = `AML sample`, values_fill = 0.0,
              values_fn = list(mRNALevels = mean)) %>%
  mutate(Gene = paste(Gene, 'mRNA')) %>%
  tibble::column_to_rownames('Gene')

## Already log transformed
# t.mat<-log10(0.01+t.mat)
missing=which(apply(t.mat,2,var)==0)

## No samples to be removed here
# t.mat<-t.mat[,-missing]

##get VAF
v.mat <- erk1.pats %>%
  select(Gene, `AML sample`, binaryMutations) %>%
  mutate(binaryMutations = case_when(binaryMutations == "1" ~ 1,
                                     binaryMutations == "0" ~ 0)) %>%
  pivot_wider(values_from = binaryMutations,names_from=`AML sample`,values_fill=0.0,
              values_fn=list(binaryMutations=max))%>%
  mutate(Gene=paste(Gene,'Gene'))%>%
  tibble::column_to_rownames('Gene')

## ph.mat does not have data for all the samples, so we intersect with what we have
## from ph.mat here.
pat.order<-intersect(pat.order,colnames(t.mat)) %>%
  intersect(colnames(ph.mat))
fullmat<-rbind(prot.mat[,pat.order],t.mat[,pat.order],ph.mat[,pat.order])

flt3.samples <- rownames(flt3.vars)
missing.samples <- setdiff(colnames(fullmat), flt3.samples)
flt3.varspadding <- data.frame("FLT3 Gene" = rep(0, 11), "KRAS Gene" = rep(0, 11),
                           "NRAS Gene" = rep(0, 11), check.names = F)
rownames(flt3.varspadding) <- missing.samples
flt3.vars <- rbind(flt3.vars, flt3.varspadding)

fannotes<-data.frame(Trametinib=annotes[colnames(fullmat),1],flt3.vars[colnames(fullmat),])


#rownames(tannotes)<-colnames(fullmat)
#,t(v.mat)[colnames(fullmat),])
#allz<-which(apply(fannotes,2,var)==0)
#fannotes<-fannotes[,-allz]

pheatmap(fullmat,cluster_rows = FALSE, show_colnames = F)

pheatmap(fullmat[sort(rownames(fullmat)),],
         cluster_rows = FALSE,cellheight=12,
         clustering_distance_cols = 'correlation',
         cluster_cols = TRUE, file='erk1_combined_heatmap.pdf',
         annotation_col = as.data.frame(fannotes) ,height=15, show_colnames = F)

pheatmap(as.matrix(prot.mat[,rownames(fannotes)]),
         cluster_rows = TRUE,cellheight=12,
        # clustering_distance_cols = 'correlation',
         cluster_cols = FALSE, file='erk1_prot_heatmap.pdf',
         annotation_col = as.data.frame(fannotes), show_colnames = F)

pheatmap(ph.mat[,rownames(fannotes)],
         cluster_rows = TRUE,cellheight=12,
         #clustering_distance_cols = 'correlation',
         cluster_cols = FALSE, file='erk1_phos_heatmap.pdf',
         annotation_col = as.data.frame(fannotes), show_colnames = F)

pheatmap(t.mat[,rownames(fannotes)],
         cluster_rows = TRUE,cellheight=12,
         #clustering_distance_cols = 'correlation',
         cluster_cols = FALSE, file='erk1_rna_heatmap.pdf',
         annotation_col = as.data.frame(fannotes), show_colnames = F)


dotplots<-lapply(subset(genecors,!is.na(pcor))$Gene,function(x)
  subset(erk1.pats,Gene==x)%>%
 #   mutate(mRNALevels=log10(0.01+mRNALevels))%>%
    mutate(mutated=as.factor(binaryMutations))%>%
    ggplot(aes(x=proteinLevels,y=Phosphosite,color=AUC,shape=site))+geom_point()+ggtitle(x)
)

p<-cowplot::plot_grid(plotlist=dotplots, ncol=2)
p
ggsave('erk1_phosphoDotPlots.pdf',p,width=12,height=12)

```


These figures suggest that mRNA and protein data are not highly correlated with drug response, as we'd expect, nor is phosphosite and protein data.

```{r phospho plots}






```


